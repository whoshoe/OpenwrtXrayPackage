name: Build Xray (Fix Include Path)

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check.outputs.version }}
      commit_sha: ${{ steps.check.outputs.commit_sha }}
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: üîç Check Latest Stable Release
        id: check
        run: |
          echo "::group::Fetching Upstream Data"
          RELEASE_JSON=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest)
          UPSTREAM_TAG=$(echo "$RELEASE_JSON" | jq -r .tag_name)
          COMMIT_SHA=$(curl -s "https://api.github.com/repos/XTLS/Xray-core/git/ref/tags/${UPSTREAM_TAG}" | jq -r .object.sha)
          UPSTREAM_VER=${UPSTREAM_TAG#v}
          
          echo "‚úÖ Latest Stable Tag: $UPSTREAM_TAG"
          echo "::endgroup::"
          
          echo "::group::Checking Local Release"
          LOCAL_TAG=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" | jq -r .tag_name || echo "v0.0.0")
          LOCAL_VER=${LOCAL_TAG#v}
          echo "‚ÑπÔ∏è  Local Version: $LOCAL_VER"
          echo "::endgroup::"

          if [ "$UPSTREAM_VER" != "$LOCAL_VER" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "version=$UPSTREAM_VER" >> $GITHUB_OUTPUT
            echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  build-ipk:
    needs: check-version
    if: needs.check-version.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch:
          - x86_64
       #   - aarch64_generic
      #    - mipsel_24kc
      #    - arm_cortex-a7_neon-vfpv4

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Patch Source Code
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          SHA="${{ needs.check-version.outputs.commit_sha }}"
          
          echo "::group::Cloning Official Makefile"
          git clone --depth 1 --filter=blob:none --sparse https://github.com/openwrt/packages.git openwrt-packages
          cd openwrt-packages
          git sparse-checkout set net/xray-core
          
          mkdir -p ../xray-core
          cp -r net/xray-core/* ../xray-core/
          cd ..
          rm -rf openwrt-packages
          echo "::endgroup::"

          echo "::group::Downloading Source Hash"
          URL="https://codeload.github.com/XTLS/Xray-core/tar.gz/v${VERSION}"
          echo "‚¨áÔ∏è  Downloading source from: $URL"
          FILE_HASH=$(curl -sL "$URL" | sha256sum | cut -d' ' -f1)
          echo "::endgroup::"
          
          echo "::group::Applying Patches"
          
          # 1. Update Version and Hash
          sed -i "s/^PKG_VERSION:=.*/PKG_VERSION:=$VERSION/" xray-core/Makefile
          sed -i "s/^PKG_HASH:=.*/PKG_HASH:=$FILE_HASH/" xray-core/Makefile
          sed -i "s/^PKG_RELEASE:=.*/PKG_RELEASE:=1/" xray-core/Makefile

          # 2. FIX THE INCLUDE PATH (The Critical Fix)
          # Replaces relative path "../../lang/golang/..." with absolute SDK path "$(TOPDIR)/feeds/packages/lang/golang/..."
          sed -i "s|\.\./\.\./lang/golang/golang-package.mk|\$(TOPDIR)/feeds/packages/lang/golang/golang-package.mk|" xray-core/Makefile

          echo "‚úÖ Makefile updated."
          grep "include" xray-core/Makefile
          echo "::endgroup::"

      - name: üèóÔ∏è Build IPK
        uses: openwrt/gh-action-sdk@v7
        env:
          ARCH: ${{ matrix.arch }}
          FEEDNAME: custom
          PACKAGES: xray-core
          NO_SHFMT_CHECK: 1
        with:
          feed_dir: .

      - name: üì¶ Move Artifacts
        run: |
          mkdir -p output
          find bin/packages -name "xray-core*.ipk" -exec mv {} output/ \;

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ipk-${{ matrix.arch }}
          path: output/*.ipk

  release:
    needs: [check-version, build-ipk]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: Xray-core v${{ needs.check-version.outputs.version }}
          body: |
            ### üöÄ Stable Build
            
            **Version:** `v${{ needs.check-version.outputs.version }}`
            **Commit SHA:** `${{ needs.check-version.outputs.commit_sha }}`
            
            Automated build from stable release.
          files: artifacts/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
