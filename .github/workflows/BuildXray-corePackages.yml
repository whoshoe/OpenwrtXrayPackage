name: Build Xray-core for OpenWrt 24.10

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

env:
  SDK_URL: "https://downloads.openwrt.org/releases/24.10.5/targets/x86/64/openwrt-sdk-24.10.5-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
  TARGET_ARCH: "x86_64"
  UPSTREAM_REPO: "XTLS/Xray-core"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Helper
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev \
          zlib1g-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3 file

      # --- LOGIC STEP 1: Find Version & Checkout Code ---
      - name: Resolve Latest Xray Version
        id: xray_info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Fetching latest release from $UPSTREAM_REPO..."
          
          LATEST_TAG=$(gh release list \
            --repo $UPSTREAM_REPO \
            --exclude-drafts \
            --exclude-pre-releases \
            --limit 1 \
            --json tagName \
            --jq '.[0].tagName')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Could not find a valid tag."
            exit 1
          fi

          echo "Latest Tag found: $LATEST_TAG"
          
          git clone https://github.com/$UPSTREAM_REPO.git upstream-src
          cd upstream-src
          git checkout $LATEST_TAG
          
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "Commit Hash: $COMMIT_HASH"
          
          CLEAN_VER=${LATEST_TAG#v}
          
          echo "version=$CLEAN_VER" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      # --- LOGIC STEP 2: Setup SDK & Build ---
      - name: Setup OpenWrt SDK
        run: |
          echo "Downloading SDK..."
          wget -O sdk.tar.zst "$SDK_URL"
          mkdir sdk
          tar -I zstd -xf sdk.tar.zst -C sdk --strip-components=1
          
          cd sdk
          # 1. Update the basic feeds first
          ./scripts/feeds update -a

      # --- NEW STEP: FORCE UPDATE GOLANG ---
      - name: Upgrade Golang to Latest (Master)
        working-directory: sdk
        run: |
          echo "Replacing stable Golang with Master (Snapshot) version..."
          
          # Remove the old golang definition from the stable feed
          rm -rf feeds/packages/lang/golang
          
          # Clone the latest packages repo (shallow clone for speed)
          git clone https://github.com/openwrt/packages.git --depth 1 -b master temp_packages
          
          # Copy the fresh golang definition into our feed
          cp -r temp_packages/lang/golang feeds/packages/lang/
          
          # Clean up
          rm -rf temp_packages
          
          # Re-install the feeds so the SDK picks up the new Golang
          ./scripts/feeds install -a

      - name: Configure Package with New Version
        env:
          VER: ${{ steps.xray_info.outputs.version }}
          HASH: ${{ steps.xray_info.outputs.commit }}
        run: |
          cd sdk
          
          PKG_PATH=$(find feeds/packages -name xray-core -type d | head -n 1)
          echo "Found existing package at: $PKG_PATH"
          
          sed -i "s/^PKG_VERSION:=.*/PKG_VERSION:=$VER/" $PKG_PATH/Makefile
          sed -i "s/^PKG_SOURCE_VERSION:=.*/PKG_SOURCE_VERSION:=$HASH/" $PKG_PATH/Makefile
          sed -i "s/^PKG_RELEASE:=.*/PKG_RELEASE:=1/" $PKG_PATH/Makefile
          sed -i "s/^PKG_MIRROR_HASH:=.*/PKG_MIRROR_HASH:=skip/" $PKG_PATH/Makefile
          
          ./scripts/feeds install -a

      - name: Compile Xray-core
        working-directory: sdk
        run: |
          make defconfig
          # Compile xray-core. This will now trigger building the NEW Go toolchain first.
          make package/xray-core/compile -j$(nproc) V=s || true
          
          find bin/packages -name "xray-core*.ipk"

      - name: Prepare Artifacts
        run: |
          mkdir -p output
          find sdk/bin/packages -name "xray-core*.ipk" -exec cp {} output/ \;
          ls -l output/

      # --- LOGIC STEP 3: Upload to Release ---
      - name: Generate Release Notes
        run: |
          echo "## Xray-core OpenWrt Build" > release_notes.md
          echo "- **Upstream Version:** ${{ steps.xray_info.outputs.tag }}" >> release_notes.md
          echo "- **Commit:** ${{ steps.xray_info.outputs.commit }}" >> release_notes.md
          echo "- **SDK Version:** 24.10.5" >> release_notes.md
          echo "- **Note:** Built using latest Golang from OpenWrt Master." >> release_notes.md
          echo "- **Built Date:** $(date)" >> release_notes.md

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.xray_info.outputs.tag }}-openwrt
          name: Xray-core ${{ steps.xray_info.outputs.tag }} (OpenWrt 24.10.5)
          body_path: release_notes.md
          files: output/*.ipk
