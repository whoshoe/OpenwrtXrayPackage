name: Check and Update Xray-Core

on:
  schedule:
    - cron: '0 16 * * *' # Runs daily at midnight UTC
  workflow_dispatch: # Allows you to manually click "Run workflow" for testing

jobs:
  check-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Important: Required to push commits and tags back to the repo

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
            token: ${{ secrets.ACTIONS_PAT }} # Use PAT token
            fetch-depth: 0
    
      - name: Check for Updates and Trigger Build
        run: |
          # 1. Fetch the latest tag from upstream (XTLS/Xray-core)
          LATEST_TAG=$(curl -s "https://api.github.com/repos/XTLS/Xray-core/releases/latest" | jq -r .tag_name)
          
          # Strip the 'v' prefix for the Makefile (e.g., v1.8.4 -> 1.8.4)
          # We assume your Makefile PKG_VERSION does not include the 'v'
          NEW_VERSION=${LATEST_TAG#v}

          echo "Latest Upstream Version: $NEW_VERSION"

          # 2. Get current version from local Makefile
          # Extract the value after PKG_VERSION:=
          CURRENT_VERSION=$(awk -F':=' '/^PKG_VERSION:=/ {print $2}' Makefile | tr -d '[:space:]')
          
          echo "Current Local Version: $CURRENT_VERSION"

          # 3. Compare versions
          if [ "$NEW_VERSION" != "$CURRENT_VERSION" ]; then
            echo "New version detected! Proceeding with update..."

            # Calculate SHA256 of the new source code
            # We use the original LATEST_TAG (with 'v') for the download URL
            DOWNLOAD_URL="https://codeload.github.com/XTLS/Xray-core/tar.gz/${LATEST_TAG}"
            echo "Downloading from: $DOWNLOAD_URL"
            
            SHA=$(curl -sL "$DOWNLOAD_URL" | sha256sum | awk '{print $1}')
            
            if [ -z "$SHA" ]; then
              echo "Error: Failed to calculate SHA256."
              exit 1
            fi
            
            echo "Calculated Hash: $SHA"

            # 4. Update the Makefile
            # Update PKG_VERSION
            sed -i "s/^PKG_VERSION:=.*/PKG_VERSION:=${NEW_VERSION}/" Makefile
            # Update PKG_HASH
            sed -i "s/^PKG_HASH:=.*/PKG_HASH:=${SHA}/" Makefile
            # Reset PKG_RELEASE to 1
            sed -i "s/^PKG_RELEASE:=.*/PKG_RELEASE:=1/" Makefile

            # 5. Commit and Push Changes
            git config --global user.name "GitHub Action"
            git config --global user.email "action@github.com"

            git add Makefile
            git commit -m "Auto-update xray-core to $NEW_VERSION"
            git push origin master

            # 6. Create a Tag to Trigger the Build
            # Your existing build workflow listens for tags ('*').
            # Pushing this tag will automatically start the build pipeline.
            git tag "${LATEST_TAG}"
            git push origin "${LATEST_TAG}"
            
            echo "Update complete. Build pipeline triggered for tag ${LATEST_TAG}."
          else
            echo "No update needed. Local version matches upstream."
          fi
